package com.reajason.noone.core.plugin;

import sun.misc.Unsafe;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;
import java.nio.file.Files;
import java.nio.file.Paths;


public class JarLoader extends ClassLoader {
    private static String MemoryBufferURLConnection = "cafebabe0000003100b70700020100296a61724d656d6f72794275666665722f4d656d6f727942756666657255524c436f6e6e656374696f6e0700040100166a6176612f6e65742f55524c436f6e6e656374696f6e01000566696c65730100104c6a6176612f7574696c2f4c6973743b01000b636f6e74656e74547970650100124c6a6176612f6c616e672f537472696e673b010004646174610100025b420100083c636c696e69743e010003282956010004436f646507000f0100136a6176612f7574696c2f41727261794c6973740a000e00110c0012000c0100063c696e69743e09000100140c0005000607001601000c6a6176612f6e65742f55524c08001801000868616e646c6572730a001a001c07001b01000f6a6176612f6c616e672f436c6173730c001d001e0100106765744465636c617265644669656c6401002d284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f7265666c6563742f4669656c643b08002001000870685f63616368650a002200240700230100176a6176612f6c616e672f7265666c6563742f4669656c640c0025002601000d73657441636365737369626c65010004285a29560a002200280c0029002a010003676574010026284c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b07002c01000d6a6176612f7574696c2f4d617008002e01000a6a61726d656d627566660b002b00300c0031003201000b636f6e7461696e734b6579010015284c6a6176612f6c616e672f4f626a6563743b295a0b002b002807003501002c6a61724d656d6f72794275666665722f4d656d6f727942756666657255524c53747265616d48616e646c65720a003400110b002b00380c0039003a010003707574010038284c6a6176612f6c616e672f4f626a6563743b4c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b0a003c003e07003d0100106a6176612f6c616e672f4f626a6563740c003f0040010008676574436c61737301001328294c6a6176612f6c616e672f436c6173733b08004201000867657446696c65730a001a00440c004500460100096765744d6574686f64010040284c6a6176612f6c616e672f537472696e673b5b4c6a6176612f6c616e672f436c6173733b294c6a6176612f6c616e672f7265666c6563742f4d6574686f643b0a0048004a0700490100186a6176612f6c616e672f7265666c6563742f4d6574686f640c004b004c010006696e766f6b65010039284c6a6176612f6c616e672f4f626a6563743b5b4c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b07004e01000e6a6176612f7574696c2f4c69737407005001001e6a6176612f6c616e672f4e6f537563684669656c64457863657074696f6e0700520100136a6176612f6c616e672f457863657074696f6e01000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c6501000d6465636c617265644669656c640100194c6a6176612f6c616e672f7265666c6563742f4669656c643b01001c6d656d6f727942756666657255524c53747265616d48616e646c65720100124c6a6176612f6c616e672f4f626a6563743b010001650100204c6a6176612f6c616e672f4e6f537563684669656c64457863657074696f6e3b0100036d617001000f4c6a6176612f7574696c2f4d61703b010011284c6a6176612f6e65742f55524c3b29560a0003005f0c0012005d0a001500610c0062006301000767657446696c6501001428294c6a6176612f6c616e672f537472696e673b0a006500670700660100106a6176612f6c616e672f537472696e670c00680069010007696e6465784f66010004284929490a0065006b0c006c006d010009737562737472696e67010016284949294c6a6176612f6c616e672f537472696e673b0a006f00710700700100116a6176612f6c616e672f496e74656765720c007200730100087061727365496e74010015284c6a6176612f6c616e672f537472696e673b29490b004d00750c002900760100152849294c6a6176612f6c616e672f4f626a6563743b07000a09000100790c0009000a0a0065007b0c006c007c0100152849294c6a6176612f6c616e672f537472696e673b090001007e0c000700080100047468697301002b4c6a61724d656d6f72794275666665722f4d656d6f727942756666657255524c436f6e6e656374696f6e3b01000375726c01000e4c6a6176612f6e65742f55524c3b01000466696c650100014901000963726561746555524c010024285b424c6a6176612f6c616e672f537472696e673b294c6a6176612f6e65742f55524c3b01000a457863657074696f6e7307008901001e6a6176612f6e65742f4d616c666f726d656455524c457863657074696f6e0b004d008b0c008c003201000361646408008e0100000700900100176a6176612f6c616e672f537472696e674275696c6465720b004d00920c0093009401000473697a650100032829490a006500960c0097007c01000776616c75654f660a008f00990c0012009a010015284c6a6176612f6c616e672f537472696e673b295608009c0100012f0a008f009e0c009f00a0010006617070656e6401002d284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e674275696c6465723b0a008f00a20c00a30063010008746f537472696e670a001500a50c001200a6010039284c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f537472696e673b4c6a6176612f6c616e672f537472696e673b295601000462417272010003737472010007636f6e6e6563740700ab0100136a6176612f696f2f494f457863657074696f6e010010676574436f6e74656e744c656e67746801000e676574436f6e74656e745479706501000e676574496e70757453747265616d01001728294c6a6176612f696f2f496e70757453747265616d3b0700b101001c6a6176612f696f2f427974654172726179496e70757453747265616d0a00b000b30c001200b4010005285b42295601000a536f7572636546696c6501001e4d656d6f727942756666657255524c436f6e6e656374696f6e2e6a61766100210001000300000003000a000500060000001200070008000000120009000a000000070008000b000c0001000d000001520003000400000088014bbb000e59b70010b3001312151217b600194ba700144d1215121fb600194ba700084ea700044e2a04b600212a01b60027c0002b4d2c594ec22c122db9002f020099000f2c122db9003302004ca70015bb003459b700364c2c122d2bb900370300572bb6003b124103bd001ab600432b03bd003cb60047c0004db300132dc3a700072dc3bf4bb10006000c00140017004f001800200023004f0018002000270051003a00800083000000830085008300000000008600860051000200530000004e00130000001500020017000c00190014001a0018001c0020001d0027001f00280023002d002400360025003a002600450027004e0028005100290059002a0063002c007e00250086002e00870031005400000034000500020084005500560000004e00030057005800010059002a005700580001001800100059005a000200360050005b005c000200040012005d0001000d000000ba00050005000000462a2bb7005e2bb600604d2c102fb600643eb20013593a04c22ab200132c031db6006ab8006eb900740200c00077b500781904c3a700071904c3bf2a2c1d0460b6007ab5007db1000200180033003600000036003900360000000200530000002200080000003400050035000a0036001100370018003800300037003a003a0045003b00540000002a000400000046007f0080000000000046008100820001000a003c00830008000200110035006800840003000900850086000200870000000400010088000d000000ae0008000400000046b20013594ec2b200132ab9008a020057bb001559122d128dbb008f59b20013b9009101000464b80095b70098129bb6009d2bb6009db600a1b700a44d2dc3a700062dc3bf2cb000020006003e004100000041004300410000000200530000001600050000003f0006004000100041003c003f0044004300540000002a00040000004600a7000a00000000004600a800080001003c000500810082000200440002008100820002000100a9000c0002008700000004000100aa000d0000002b0000000100000001b10000000200530000000600010000004700540000000c000100000001007f00800000000100ac00940001000d0000003000010001000000062ab40078beac0000000200530000000600010000004a00540000000c000100000006007f00800000000100ad00630001000d0000002f00010001000000052ab4007db00000000200530000000600010000004e00540000000c000100000005007f00800000000100ae00af0002008700000004000100aa000d00000036000300010000000cbb00b0592ab40078b700b2b00000000200530000000600010000005200540000000c00010000000c007f00800000000100b50000000200b6";
    private static String MemoryBufferURLStreamHandler = "cafebabe00000031002507000201002c6a61724d656d6f72794275666665722f4d656d6f727942756666657255524c53747265616d48616e646c65720700040100196a6176612f6e65742f55524c53747265616d48616e646c657201000566696c65730100104c6a6176612f7574696c2f4c6973743b0100063c696e69743e010003282956010004436f64650a0003000b0c0007000807000d0100136a6176612f7574696c2f41727261794c6973740a000c000b09000100100c0005000601000f4c696e654e756d6265725461626c650100124c6f63616c5661726961626c655461626c650100047468697301002e4c6a61724d656d6f72794275666665722f4d656d6f727942756666657255524c53747265616d48616e646c65723b01000867657446696c657301001228294c6a6176612f7574696c2f4c6973743b01000e6f70656e436f6e6e656374696f6e010028284c6a6176612f6e65742f55524c3b294c6a6176612f6e65742f55524c436f6e6e656374696f6e3b01000a457863657074696f6e7307001b0100136a6176612f696f2f494f457863657074696f6e07001d0100296a61724d656d6f72794275666665722f4d656d6f727942756666657255524c436f6e6e656374696f6e0a001c001f0c00070020010011284c6a6176612f6e65742f55524c3b295601000375726c01000e4c6a6176612f6e65742f55524c3b01000a536f7572636546696c650100214d656d6f727942756666657255524c53747265616d48616e646c65722e6a6176610021000100030000000100020005000600000003000100070008000100090000004200030001000000102ab7000a2abb000c59b7000eb5000fb10000000200110000000e00030000000b0004000c000f000b00120000000c000100000010001300140000000100150016000100090000002f00010001000000052ab4000fb00000000200110000000600010000000f00120000000c00010000000500130014000000010017001800020019000000040001001a00090000003d0003000200000009bb001c592bb7001eb0000000020011000000060001000000140012000000160002000000090013001400000000000900210022000100010023000000020024";
    private static Class mconnClass;
    private static Unsafe unsafe;
    private static JarLoader classLoader;

    static {
        classLoader = new JarLoader(ClassLoader.getSystemClassLoader());
        classLoader.g(hexToByte(MemoryBufferURLStreamHandler));
        mconnClass = classLoader.g(hexToByte(MemoryBufferURLConnection));
        unsafe = getUnsafe();
    }

    public static void main(String[] args) throws Exception {
        byte[] jarData = Files.readAllBytes(Paths.get("/Users/reajason/.m2/repository/org/ow2/asm/asm/9.8/asm-9.8.jar"));
        try {
            Class<?> clazz = ClassLoader.getSystemClassLoader().loadClass("org.objectweb.asm.Opcodes");
        } catch (ClassNotFoundException e) {
            System.out.println("class not found");
        }
        if (addJar((URL) mconnClass.getMethod("createURL", byte[].class, String.class).invoke(null, jarData, "application/jar"))) {
            Class<?> clazz = ClassLoader.getSystemClassLoader().loadClass("org.objectweb.asm.Opcodes");
            System.out.println(clazz);
        }
    }

    public static Field getField(Class clazz, String fieldName) {
        Field field = null;
        while (clazz != null) {
            try {
                field = clazz.getDeclaredField(fieldName);
                break;
            } catch (Exception e) {
                clazz = clazz.getSuperclass();
            }
        }
        return field;
    }

    private static Method getMethod(Class clazz, String methodName, Class[] params) throws SecurityException {
        Method method = null;
        while (clazz != null) {
            try {
                method = clazz.getDeclaredMethod(methodName, params);
                break;
            } catch (NoSuchMethodException e) {
                clazz = clazz.getSuperclass();
            }
        }
        return method;
    }

    private static boolean addJar(URL url) throws SecurityException, IllegalArgumentException {
        try {
            ClassLoader systemLoader = ClassLoader.getSystemClassLoader();
            if (URLClassLoader.class.isInstance(systemLoader)) {
                URLClassLoader classLoader = (URLClassLoader) ClassLoader.getSystemClassLoader();
                Method method = URLClassLoader.class.getDeclaredMethod("addURL", URL.class);
                if (!method.isAccessible()) {
                    method.setAccessible(true);
                }
                method.invoke(classLoader, url);
                return true;
            }
            Field ucpField = getField(systemLoader.getClass(), "ucp");
            Object ucp = null;
            Method addURLMethod = null;
            try {
                ucpField.setAccessible(true);
                ucp = ucpField.get(systemLoader);
                addURLMethod = getMethod(ucp.getClass(), "addURL", new Class[]{URL.class});
                addURLMethod.setAccessible(true);
            } catch (Exception e) {
                Class targetClass = ucpField.getType();
                Method getModuleMethod = getMethod(Class.class, "getModule", new Class[0]);
                if (getModuleMethod != null) {
                    Object oldModule = getModuleMethod.invoke(JarLoader.class, new Object[0]);
                    Object targetModule = getModuleMethod.invoke(targetClass, new Object[0]);
                    unsafe.getAndSetObject(JarLoader.class, unsafe.objectFieldOffset(Class.class.getDeclaredField("module")), targetModule);
                    try {
                        ucpField.setAccessible(true);
                        ucp = ucpField.get(systemLoader);
                        addURLMethod = getMethod(ucp.getClass(), "addURL", new Class[]{URL.class});
                        addURLMethod.setAccessible(true);
                    } catch (Throwable th) {
                    }
                    unsafe.getAndSetObject(JarLoader.class, unsafe.objectFieldOffset(Class.class.getDeclaredField("module")), oldModule);
                }
            }
            addURLMethod.invoke(ucp, url);
            return true;
        } catch (Exception e2) {
            throw new RuntimeException(e2);
        }
    }

    private static Unsafe getUnsafe() {
        try {
            Field field = Unsafe.class.getDeclaredField("theUnsafe");
            field.setAccessible(true);
            return (Unsafe) field.get(null);
        } catch (Exception e) {
            return null;
        }
    }

    public JarLoader() {
    }

    public JarLoader(ClassLoader classLoader) {
        super(classLoader);
    }

    public Class<?> g(byte[] b) {
        return super.defineClass(b, 0, b.length);
    }

    public static byte[] hexToByte(String hex) {
        int byteLen = hex.length() / 2;
        byte[] ret = new byte[byteLen];
        for (int i = 0; i < byteLen; i++) {
            int m = (i * 2) + 1;
            int n = m + 1;
            int intVal = Integer.decode("0x" + hex.substring(i * 2, m) + hex.substring(m, n)).intValue();
            ret[i] = Byte.valueOf((byte) intVal).byteValue();
        }
        return ret;
    }
}